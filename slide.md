# Webアプリケーション開発入門
### 第１回

<br><br>

木村 憲規

@KazunoriJs

------

### Webアプリケーションとは？

今回の勉強会では、以下のように定義します。

<br>

クライアントからのリクエストごとに、サーバー側の処理で状況に合わせたページが生成されることにより、何かしらの機能が提供されるWebサイト

<br>
<br>

このようなWebサイトを`Webサービス`と呼ぶ場合もあります。


------

### Webアプリケーション開発

* [Nodeビギナーズブック](http://www.nodebeginner.org/index-jp.html) より

<br>

もし貴方が私と同じであれば、はるか昔HTMLの文書を書いて
HTMLでの"開発"を始めたはずです。

<br>

JavaScriptと呼ばれるなんだか面白そうなものに出会い、
つまり貴方のWebページに相互作用を加えるような、
とても基本的な使い方だけで利用していたことでしょう。

------

貴方はもっと"本物"が欲しくなり、複雑なWebサイトを構築する方法を学びたくて
PHP、 Ruby、Javaなどのプログラミング言語を勉強し、
"バックエンド" となるコードを書き始めたのではないでしょうか。

------

みなさんはどうですか？

<br>

* HTMLを書いたことがありますか？
* JavaScriptを書いたことがありますか？
* PHP、Ruby、JavaなどでWebアプリケーションを書いたことがありますか？

------

* [Nodeビギナーズブック](http://www.nodebeginner.org/index-jp.html) は以下のようにつづきます。

<br>

JavaScriptに注目してみると  
jQuery や Prototype などが目に入ってきました。

<br>

JavaScriptの世界では物事が進化し、  
もはやこの言語は、`window.open()`では済まないのだ、  
ということがわかってきたのです。

<br><br>

そしていま、`Node.js`にたどり着きました。


------

# HTTPについて

------

### HTTP: Hypertext Transfer Protocol

`Hypertext Transfer Protocol`（ハイパーテキスト・トランスファー・プロトコル、略称 HTTP）とは、
WebブラウザとWebサーバの間でHTMLなどのコンテンツの送受信に用いられる通信プロトコルである。

`RFC 2616`で規定されている。


* [HTTP | Wikipedia](http://ja.wikipedia.org/wiki/Hypertext_Transfer_Protocol)

------

### HTTPの動作 (1)

* [HTTP | Wikipedia](http://ja.wikipedia.org/wiki/Hypertext_Transfer_Protocol)より抜粋

HTTPはリクエスト-レスポンス型のプロトコルであり、クライアントがサーバにリクエストメッセージを送信する。

基本的な考え方は非常に単純で、「何を」「どうして」欲しいのかを伝える。
URLが「何を」、メソッドが「どうして」に当たる。

------

### HTTPの動作 (2)

サーバはこれにレスポンスメッセージを返し、  
基本的にこの時点で初期状態に戻る。

サーバはクライアントの状態を保存しない。  
(ステートレス :stateless)

<br>

* クライアントの状態を管理するために、cookieを使用してセッションを管理します。

------

### メソッド (1)

* GET
  - 指定されたURIのリソースを取り出す。  
HTTPの最も基本的な動作。

* POST
  - GETとは反対にクライアントがサーバにデータを送信する。  
Webフォームや電子掲示板への投稿などで使用される。  
GETの場合と同じく、サーバはクライアントにデータを返すことができる。

------

### メソッド (2)

* PUT  
  - 指定したURIにリソースを保存する。  
URIが指し示すリソースが存在しない場合は、サーバはそのURIにリソースを作成する。  
画像のアップロードなどが代表的。

* DELETE  
  - 指定したURIのリソースを削除する。

------

### メソッド (3)

* OPTION  
  - サーバを調査する。  
例えば、サーバがサポートしているHTTPバージョンなどを知ることができる。

* HEAD  
  - GETと似ているが、サーバはHTTPヘッダのみ返す。  
クライアントはWebページを取得せずともそのWebページが存在するかどうかを知ることができる。例えばWebページのリンク先が生きているか、データを全て取得することなく検証することができる。

------

### メソッド (4)

* TRACE  
  - サーバまでのネットワーク経路をチェックする。  
サーバは受け取ったメッセージのそれ自体をレスポンスのデータにコピーして応答する。WindowsのTracertやUNIXのTracerouteとよく似た動作。

* CONNECT  
  - TCPトンネルを接続する。  
暗号化したメッセージをプロキシで転送する際に用いる。

------

### Cookie

`HTTP cookie`（エイチティーティーピークッキー、単にクッキーとも表記される）は、
`RFC 6265`などで定義されたHTTPにおけるウェブサーバとウェブブラウザ間で状態を管理するプロトコル、
またそこで用いられるウェブブラウザに保存された情報のことを指す。

ユーザ識別やセッション管理を実現する目的などに利用される。

* [Cookie](http://ja.wikipedia.org/wiki/HTTP_cookie)

------

### セッション管理

一連の処理の開始(例えばログイン処理)から終了(ログアウトあるいはブラウザの終了)までを「セッション」といいます。

HTTPはステートレスなプロトコルなので、複数の画面遷移が発生した場合に、コレを一連の処理であると識別することはできません。

しかしながら、複雑なWebアプリケーションでは不便な場面が多々あるため、セッション管理の仕組みがあります。

------

### セッション管理の概要

1. 処理の開始時にサーバー側でユニークなIDを生成し、クライアントに渡す。 (セッションID)
2. クライアントは一連の処理の間、リクエストと一緒にセッションIDをサーバーに送信する。
3. サーバーはセッションIDを元に、同一のセッションであるかどうかを判断する。

* サーバーはセッションIDとともに付随する情報を保持します。  
この情報はセッション変数に格納され、Webアプリケーションにて使用されます。

------

### HTTPの動作 (2)

* 通信の開始は必ずクライアント側からとなる
  - クライアント側がサーバーに*リクエスト(request)*を送信する
  - サーバー側はリクエストに応じてクライアント側に*レスポンス(response)*を返す

------

### サーバーサイドとクライアントサイド

[Nodeビギナーズブック](http://www.nodebeginner.org/index-jp.html) より抜粋

最初にJavaScriptが日の目を見たのは、ブラウザ上でした。  
しかしこれは単なるコンテキストに過ぎません。

<br>

コンテキストによってその言語でできることは決まってきますが、  
それはその言語自体ができることとイコールというわけではありません。  
JavaScriptは完全な言語であり、様々なコンテキストで使えます。  
他の言語でやっていることは、すべてJavaScriptでもできます。

------

* Webアプリケーション開発において、コンテキスト(文脈) を意識することが非常に重要です。
* そのプログラムがサーバー側とクライアント(ブラウザ)側のどちらで実行されるのか、どのようなタイミングで実行されるのかを理解しながら、コーディングを進めていきます。

------

### 認証について

* Basic認証

Basic認証（ベーシックにんしょう、Basic Authentication）とは、HTTPで定義される認証方式の一つ。
基本認証と呼ばれることも。

<br>

Basic認証では、ユーザ名とパスワードの組みをコロン ":" でつなぎ、Base64でエンコードして送信する。
このため、盗聴や改竄が簡単であるという欠点を持つが、
ほぼ全てのWebサーバおよびブラウザで対応しているため、広く使われている。

[Basic認証 | Wikipedia](http://ja.wikipedia.org/wiki/Basic%E8%AA%8D%E8%A8%BC)

------

#### NginxでのBasic認証

* パスワードファイルの作成
* nginx.confの更新

```
location /secret/ {
    auth_basic "basic authentication test!";
    auth_basic_user_file "/path/to/password/file";
}
```

------

# 簡単なWebアプリケーション

------

## ToDo管理システム

* 仕様
  - ToDoの登録、一覧表示、更新、削除 (CRUD)
  - ユーザー認証機能
  - ユーザーおよびToDoはデータベースで管理する

------

### 画面遷移

        +--------------+
        | ユーザー登録 | ----------+
        +--------------+           |
               ^                   |
               |                   v
        +--------------+      +----------+      +----------+
    --> | ログイン画面 | ---> | 一覧画面 | <--> | 更新画面 |
        +--------------+      +----------+      +----------+
               ^                   |                 |
               |                   |                 |
               +-------------------+-----------------+

------

### ログイン画面

* フォームからユーザー名、パスワードを受け取り、データベースで照会します。(フォーム認証)
* ユーザー名、パスワードが一致すれば、一覧画面に遷移します。
* ユーザー名、パスワードが一致しなければ、エラーメッセージを表示します。

------

### ユーザー登録画面

* フォームからユーザー名、パスワードを受け取り、データベースに登録します。
* ユーザー名が重複している場合はエラーとし、登録しません。
* 登録に成功すると、一覧画面に遷移します。

------

### 一覧画面

* ログインユーザーのToDoを全て表示します。
* 完了ボタンをクリックすると、そのToDoのステータスを完了にします。
* 追加ボタンをクリックすると、更新画面に遷移します。
* 更新ボタンをクリックすると、更新画面に遷移し、そのToDoの内容を表示します。
* 削除ボタンをクリックすると、そのToDoを削除します。

------

### 更新画面

* 追加ボタンから遷移した場合、新しいToDoの登録のためにブランクのフォームを表示します。
* 更新ボタンから遷移した場合、選択したToDoの更新のためにToDoの内容をフォームにセットします。

------

### テーブル定義

#### ToDo

```sql
create table todos (
    id integer primary key autoincrement,
    user_id integer,
    body text,
    done boolean,
    create_at datetime,
    update_at datetime
);
```

------

### テーブル定義

#### User

```sql
create table users (
    id integer primary key autoincrement,
    mail text unique,
    password text,
    last_login datetime,
    create_at datetime,
    update_at datetime
);
```

------

# 開発環境設定

------

### ツールなどのインストール

* vim, gitをインストールします。

```
$ su -
# yum install yum-fastestmirror
# yum update -y
# yum install -y vim
# yum install -y git-core
```

------

### epelリポジトリを追加

後述のremi-release-6 が依存しているため、最初にepelレポジトリを追加します。

#### 64bit

```
# rpm -ivh http://ftp.riken.jp/Linux/fedora/epel/6/x86_64/epel-release-6-8.noarch.rpm
```

#### 32bit

```
# rpm -ivh http://ftp.riken.jp/Linux/fedora/epel/6/i386/epel-release-6-8.noarch.rpm
```

------

### remi リポジトリを追加

PHPの新しいバージョンが公開されているレポジトリです。

```
# rpm -ivh http://rpms.famillecollet.com/enterprise/remi-release-6.rpm
```

------

### PHPのアップデート

remi Repositoryからphpをアップデートします。

```
# yum --enablerepo=remi update php -y
```

------

### PHPの設定

```
# vim /etc/php.ini
```

```
date.timezone = Asia/Tokyo
mbstring.internal_encoding = UTF-8
```

タイムゾーンとエンコードの設定をしておきます。

------

* sqlite入ってる？

```
# sqlite3 --version
3.6.20
# exit
```
